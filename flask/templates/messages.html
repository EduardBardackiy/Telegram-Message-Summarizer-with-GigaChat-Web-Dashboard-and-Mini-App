{% extends "base.html" %}

{% block title %}Сообщения - TGBot Monitor{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-4">
            <i class="bi bi-chat-dots-fill text-primary"></i> Все сообщения
        </h1>
        <p class="lead text-muted">Всего найдено: {{ total }} сообщений</p>
    </div>
</div>

<!-- Таблица сообщений -->
<div class="table-container">
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width: 5%">ID</th>
                    <th style="width: 15%">Отправитель</th>
                    <th style="width: 40%">Текст</th>
                    <th style="width: 15%">Дата/Время</th>
                    <th style="width: 10%">Chat ID</th>
                    <th style="width: 15%">Статус</th>
                </tr>
            </thead>
            <tbody>
                {% if messages %}
                    {% for msg in messages %}
                    <tr>
                        <td>
                            <span class="badge bg-secondary">{{ msg.id }}</span>
                        </td>
                        <td>
                            <strong>{{ msg.sender or 'Неизвестно' }}</strong>
                        </td>
                        <td>
                            <div class="message-text" title="{{ msg.text }}">
                                {{ msg.text|truncate_text(80) }}
                            </div>
                        </td>
                        <td>
                            <small class="text-muted">
                                <i class="bi bi-calendar-event"></i>
                                {{ msg.date|format_datetime }}
                            </small>
                        </td>
                        <td>
                            <code>{{ msg.chat_id }}</code>
                        </td>
                        <td>
                            {% if msg.summarized == 1 %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle"></i> Обработано
                                </span>
                            {% else %}
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-hourglass-split"></i> Ожидает
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-3">Нет сообщений в базе данных</p>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Пагинация -->
    {% if total > 50 %}
    <nav aria-label="Навигация по страницам" class="mt-4">
        <ul class="pagination justify-content-center">
            <!-- Предыдущая страница -->
            <li class="page-item {% if page == 1 %}disabled{% endif %}">
                <a class="page-link" href="?page={{ page - 1 }}" aria-label="Предыдущая">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>

            <!-- Номера страниц -->
            {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                    <li class="page-item active">
                        <span class="page-link">{{ p }}</span>
                    </li>
                {% elif p <= 3 or p > total_pages - 3 or (p >= page - 1 and p <= page + 1) %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ p }}">{{ p }}</a>
                    </li>
                {% elif p == 4 or p == total_pages - 3 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                {% endif %}
            {% endfor %}

            <!-- Следующая страница -->
            <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="?page={{ page + 1 }}" aria-label="Следующая">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>

    <div class="text-center text-muted">
        <small>
            Страница {{ page }} из {{ total_pages }} 
            (показано {{ messages|length }} из {{ total }})
        </small>
    </div>
    {% endif %}
</div>

<!-- Кнопка возврата -->
<div class="row mt-4">
    <div class="col">
        <a href="/" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Назад к дашборду
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Подсветка текущей строки при наведении
    document.querySelectorAll('tbody tr').forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f0f8ff';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
</script>
{% endblock %}

